<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç“¦ç‰¹å¾®ç”µç½‘æ•°å­—å­ªç”Ÿä»¿çœŸå¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">W</div>
            <div class="logo-text">ç“¦ç‰¹<span>å¾®ç”µç½‘</span></div>
        </div>
        <ul class="nav-links">
            <li><a href="/" class="active">é¦–é¡µ</a></li>
            <li><a href="/dashboard">ä»ªè¡¨ç›˜</a></li>
            <li><a href="/visualization">3Då¯è§†åŒ–</a></li>
            <li><a href="/storage">å‚¨èƒ½è¯¦æƒ…</a></li>
            <li><a href="/trading">ç”µåŠ›äº¤æ˜“</a></li>
            <li><a href="/agent">ç“¦ç‰¹æ™ºèƒ½ä½“</a></li>
            <li><a href="/opendata">å¼€æºæ•°æ®</a></li>
        </ul>
        <div class="status-indicator">
            <span class="status-dot online"></span>
            <span>ç³»ç»Ÿåœ¨çº¿</span>
        </div>
    </nav>

    <main class="main-content">
        <!-- è‹±é›„åŒºåŸŸ -->
        <div class="hero-section fade-in">
            <h1 class="hero-title">ç“¦ç‰¹<span>å¾®ç”µç½‘</span>æ•°å­—å­ªç”Ÿä»¿çœŸå¹³å°</h1>
            <p class="hero-subtitle">é›†æˆé«˜ç²¾åº¦ä»¿çœŸå»ºæ¨¡ã€AIæ™ºèƒ½é¢„æµ‹ã€ä¼˜åŒ–è°ƒåº¦ä¸3Då¯è§†åŒ–çš„æ–°ä¸€ä»£ç»¼åˆèƒ½æºç®¡ç†ç³»ç»Ÿï¼ŒåŠ©åŠ›ç¢³ä¸­å’Œç›®æ ‡å®ç°</p>
            <div class="hero-actions">
                <button class="btn btn-primary" onclick="location.href='/visualization'">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg>
                    è¿›å…¥3Då¯è§†åŒ–
                </button>
                <button class="btn btn-secondary" onclick="location.href='/dashboard'">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                    è¿è¥ä»ªè¡¨ç›˜
                </button>
            </div>
        </div>

        <!-- å®æ—¶ç»Ÿè®¡ -->
        <div class="stat-grid fade-in" style="animation-delay: 0.1s;">
            <div class="stat-item">
                <div class="stat-value solar" id="stat-solar">0<span class="stat-unit">kW</span></div>
                <div class="stat-label">â˜€ï¸ å…‰ä¼å‘ç”µ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value wind" id="stat-wind">0<span class="stat-unit">kW</span></div>
                <div class="stat-label">ğŸ’¨ é£åŠ›å‘ç”µ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value battery" id="stat-soc">50<span class="stat-unit">%</span></div>
                <div class="stat-label">ğŸ”‹ å‚¨èƒ½SOC</div>
            </div>
            <div class="stat-item">
                <div class="stat-value load" id="stat-load">0<span class="stat-unit">kW</span></div>
                <div class="stat-label">ğŸ­ è´Ÿè·åŠŸç‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-value grid" id="stat-grid">0<span class="stat-unit">kW</span></div>
                <div class="stat-label">ğŸ”Œ ç”µç½‘äº¤æ¢</div>
            </div>
        </div>

        <!-- åŠŸèƒ½å¡ç‰‡ -->
        <div class="grid-4" style="margin-bottom: 32px;">
            <div class="feature-card fade-in" style="animation-delay: 0.15s;">
                <div class="feature-icon">ğŸ”„</div>
                <div class="feature-title">é«˜ç²¾åº¦ä»¿çœŸå¼•æ“</div>
                <div class="feature-desc">æ”¯æŒå…‰ä¼ã€é£ç”µã€å‚¨èƒ½ã€æŸ´æ²¹æœºç­‰å¤šç§åˆ†å¸ƒå¼èƒ½æºè®¾å¤‡çš„ç²¾ç¡®å»ºæ¨¡ä¸ä»¿çœŸ</div>
                <button class="btn btn-secondary" onclick="startQuickSimulation()">å¿«é€Ÿä»¿çœŸ</button>
            </div>
            <div class="feature-card fade-in" style="animation-delay: 0.2s;">
                <div class="feature-icon">ğŸ“Š</div>
                <div class="feature-title">å…¨é‡æ•°æ®ç®¡ç†</div>
                <div class="feature-desc">å®æ—¶é‡‡é›†ä¸å­˜å‚¨è¿è¡Œæ•°æ®ï¼Œæ”¯æŒå†å²æ•°æ®åˆ†æã€æŠ¥è¡¨å¯¼å‡ºä¸å¯è§†åŒ–å±•ç¤º</div>
                <button class="btn btn-secondary" onclick="location.href='/dashboard'">æŸ¥çœ‹æ•°æ®</button>
            </div>
            <div class="feature-card fade-in" style="animation-delay: 0.25s;">
                <div class="feature-icon">ğŸ¯</div>
                <div class="feature-title">æ™ºèƒ½æ¨¡å‹æ ‡å®š</div>
                <div class="feature-desc">åŸºäºå®é™…è¿è¡Œæ•°æ®è‡ªåŠ¨æ ‡å®šä»¿çœŸæ¨¡å‹å‚æ•°ï¼ŒæŒç»­æå‡ä»¿çœŸç²¾åº¦ä¸å¯é æ€§</div>
                <button class="btn btn-secondary" onclick="location.href='/dashboard'">å¼€å§‹æ ‡å®š</button>
            </div>
            <div class="feature-card fade-in" style="animation-delay: 0.3s;">
                <div class="feature-icon">âš¡</div>
                <div class="feature-title">ç»æµè°ƒåº¦ä¼˜åŒ–</div>
                <div class="feature-desc">ç»“åˆç”µä»·é¢„æµ‹ä¸è´Ÿè·é¢„æµ‹ï¼Œå®ç°å³°è°·å¥—åˆ©ä¸ç»æµè°ƒåº¦ï¼Œæ˜¾è‘—é™ä½ç”¨èƒ½æˆæœ¬</div>
                <button class="btn btn-secondary" onclick="runOptimization()">è¿è¡Œä¼˜åŒ–</button>
            </div>
        </div>

        <!-- å®æ—¶æ•°æ®åŒºåŸŸ -->
        <div class="grid-2">
            <div class="card fade-in" style="animation-delay: 0.35s;">
                <div class="card-title">ğŸ“ˆ ç³»ç»Ÿå®æ—¶çŠ¶æ€</div>
                <div class="data-panel">
                    <div class="data-row" style="border-color: var(--solar);">
                        <span class="data-label">â˜€ï¸ å…‰ä¼å‡ºåŠ›</span>
                        <span class="data-value solar" id="solar-power">0.00 kW</span>
                    </div>
                    <div class="data-row" style="border-color: var(--wind);">
                        <span class="data-label">ğŸ’¨ é£æœºå‡ºåŠ›</span>
                        <span class="data-value wind" id="wind-power">0.00 kW</span>
                    </div>
                    <div class="data-row" style="border-color: var(--battery);">
                        <span class="data-label">ğŸ”‹ å‚¨èƒ½ç”µé‡</span>
                        <span class="data-value battery" id="battery-soc">50.0%</span>
                    </div>
                    <div class="data-row" style="border-color: var(--load);">
                        <span class="data-label">ğŸ­ è´Ÿè·éœ€æ±‚</span>
                        <span class="data-value load" id="load-power">0.00 kW</span>
                    </div>
                    <div class="data-row" style="border-color: var(--grid);">
                        <span class="data-label">ğŸ”Œ ç”µç½‘äº¤æ¢</span>
                        <span class="data-value grid" id="grid-power">0.00 kW</span>
                    </div>
                </div>
            </div>

            <div class="card fade-in" style="animation-delay: 0.4s;">
                <div class="card-title">ğŸ“Š å®æ—¶åŠŸç‡æ›²çº¿</div>
                <div class="chart-container">
                    <canvas id="realtime-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- ä»¿çœŸé…ç½® -->
        <div class="card fade-in" style="animation-delay: 0.45s;">
            <div class="card-title">âš™ï¸ ä»¿çœŸå‚æ•°é…ç½®</div>
            <div class="grid-4">
                <div class="input-group">
                    <label>å…‰ä¼å®¹é‡ (kW)</label>
                    <input type="number" id="solar-capacity" value="100" min="0">
                </div>
                <div class="input-group">
                    <label>é£ç”µå®¹é‡ (kW)</label>
                    <input type="number" id="wind-capacity" value="50" min="0">
                </div>
                <div class="input-group">
                    <label>ç”µæ± å®¹é‡ (kWh)</label>
                    <input type="number" id="battery-capacity" value="500" min="0">
                </div>
                <div class="input-group">
                    <label>åŸºç¡€è´Ÿè· (kW)</label>
                    <input type="number" id="base-load" value="80" min="0">
                </div>
            </div>
            <div style="display: flex; gap: 16px; margin-top: 8px;">
                <button class="btn btn-primary" onclick="startSimulation()">å¼€å§‹ä»¿çœŸ</button>
                <button class="btn btn-secondary" onclick="resetParameters()">é‡ç½®å‚æ•°</button>
            </div>
        </div>
    </main>

    <script>
        // å›¾è¡¨é…ç½®
        const ctx = document.getElementById('realtime-chart').getContext('2d');
        const realtimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'å…‰ä¼', data: [], borderColor: '#ff9500', backgroundColor: 'rgba(255,149,0,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                    { label: 'é£ç”µ', data: [], borderColor: '#00b578', backgroundColor: 'rgba(0,181,120,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 },
                    { label: 'è´Ÿè·', data: [], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', tension: 0.4, fill: true, pointRadius: 0, borderWidth: 2 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        labels: { 
                            color: '#666666', 
                            font: { size: 12, family: 'Noto Sans SC' },
                            usePointStyle: true
                        } 
                    } 
                },
                scales: {
                    x: { 
                        ticks: { color: '#999999', font: { size: 11 } }, 
                        grid: { color: 'rgba(0,0,0,0.05)' } 
                    },
                    y: { 
                        ticks: { color: '#999999', font: { size: 11 } }, 
                        grid: { color: 'rgba(0,0,0,0.05)' } 
                    }
                }
            }
        });

        // WebSocket
        let ws = null;
        function connectWebSocket() {
            try {
                ws = new WebSocket(`ws://${location.host}/api/ws/realtime`);
                ws.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                };
                ws.onclose = function() { setTimeout(connectWebSocket, 3000); };
                ws.onerror = function() {};
            } catch (e) {
                setTimeout(connectWebSocket, 3000);
            }
        }

        let dataPointCounter = 0;
        let lastUpdateTime = 0;
        
        function updateDisplay(data) {
            document.getElementById('solar-power').textContent = data.solar_power.toFixed(2) + ' kW';
            document.getElementById('wind-power').textContent = data.wind_power.toFixed(2) + ' kW';
            document.getElementById('battery-soc').textContent = (data.battery_soc * 100).toFixed(1) + '%';
            document.getElementById('load-power').textContent = data.load_power.toFixed(2) + ' kW';
            document.getElementById('grid-power').textContent = data.grid_power.toFixed(2) + ' kW';

            document.getElementById('stat-solar').innerHTML = data.solar_power.toFixed(0) + '<span class="stat-unit">kW</span>';
            document.getElementById('stat-wind').innerHTML = data.wind_power.toFixed(0) + '<span class="stat-unit">kW</span>';
            document.getElementById('stat-soc').innerHTML = (data.battery_soc * 100).toFixed(0) + '<span class="stat-unit">%</span>';
            document.getElementById('stat-load').innerHTML = data.load_power.toFixed(0) + '<span class="stat-unit">kW</span>';
            document.getElementById('stat-grid').innerHTML = data.grid_power.toFixed(0) + '<span class="stat-unit">kW</span>';

            // ç¡®ä¿æ¯æ¬¡æ›´æ–°éƒ½æœ‰å”¯ä¸€çš„æ—¶é—´æˆ³ï¼ˆè‡³å°‘é—´éš”1ç§’ï¼‰
            const now = Date.now();
            if (now - lastUpdateTime < 1000) return;
            lastUpdateTime = now;
            
            const date = new Date(now);
            const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            realtimeChart.data.labels.push(timeStr);
            realtimeChart.data.datasets[0].data.push(data.solar_power);
            realtimeChart.data.datasets[1].data.push(data.wind_power);
            realtimeChart.data.datasets[2].data.push(data.load_power);

            if (realtimeChart.data.labels.length > 20) {
                realtimeChart.data.labels.shift();
                realtimeChart.data.datasets.forEach(ds => ds.data.shift());
            }
            realtimeChart.update('none');
        }

        async function startQuickSimulation() {
            const response = await fetch('/api/simulation/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: 'å¿«é€Ÿä»¿çœŸ', duration_hours: 24 })
            });
            const result = await response.json();
            alert('ä»¿çœŸå®Œæˆï¼æ•°æ®å·²ä¿å­˜ã€‚');
        }

        async function startSimulation() {
            const params = {
                name: 'è‡ªå®šä¹‰ä»¿çœŸ',
                duration_hours: 24,
                solar_capacity: parseFloat(document.getElementById('solar-capacity').value),
                wind_capacity: parseFloat(document.getElementById('wind-capacity').value),
                battery_capacity: parseFloat(document.getElementById('battery-capacity').value),
                base_load: parseFloat(document.getElementById('base-load').value)
            };
            const response = await fetch('/api/simulation/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            alert('ä»¿çœŸå®Œæˆï¼');
        }

        async function runOptimization() {
            const response = await fetch('/api/optimization/dispatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            alert(`ä¼˜åŒ–å®Œæˆï¼æ€»æˆæœ¬: ${result.total_cost} å…ƒ`);
        }

        function resetParameters() {
            document.getElementById('solar-capacity').value = 100;
            document.getElementById('wind-capacity').value = 50;
            document.getElementById('battery-capacity').value = 500;
            document.getElementById('base-load').value = 80;
        }

        connectWebSocket();
    </script>
</body>
</html>
