<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»ªè¡¨ç›˜ - ç“¦ç‰¹å¾®ç”µç½‘æ•°å­—å­ªç”Ÿä»¿çœŸå¹³å°</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">W</div>
            <div class="logo-text">ç“¦ç‰¹<span>å¾®ç”µç½‘</span></div>
        </div>
        <ul class="nav-links">
            <li><a href="/">é¦–é¡µ</a></li>
            <li><a href="/dashboard" class="active">ä»ªè¡¨ç›˜</a></li>
            <li><a href="/visualization">3Då¯è§†åŒ–</a></li>
            <li><a href="/storage">å‚¨èƒ½è¯¦æƒ…</a></li>
            <li><a href="/trading">ç”µåŠ›äº¤æ˜“</a></li>
            <li><a href="/agent">ç“¦ç‰¹æ™ºèƒ½ä½“</a></li>
            <li><a href="/opendata">å¼€æºæ•°æ®</a></li>
        </ul>
        <div class="status-indicator">
            <span class="status-dot online"></span>
            <span>ç³»ç»Ÿåœ¨çº¿</span>
        </div>
    </nav>

    <main class="main-content">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs fade-in">
            <button class="tab active" onclick="showTab('simulation')">ğŸ”„ ä»¿çœŸç®¡ç†</button>
            <button class="tab" onclick="showTab('prediction')">ğŸ“Š é¢„æµ‹åˆ†æ</button>
            <button class="tab" onclick="showTab('optimization')">âš¡ è°ƒåº¦ä¼˜åŒ–</button>
            <button class="tab" onclick="showTab('calibration')">ğŸ¯ æ¨¡å‹æ ‡å®š</button>
        </div>

        <!-- ä»¿çœŸç®¡ç† -->
        <div id="simulation-tab" class="tab-content">
            <div class="grid-2">
                <div class="card fade-in">
                    <div class="card-title">ğŸ”„ æ–°å»ºä»¿çœŸ</div>
                    <div class="input-group">
                        <label>ä»¿çœŸåç§°</label>
                        <input type="text" id="sim-name" value="ä»¿çœŸæµ‹è¯•" placeholder="è¾“å…¥ä»¿çœŸåç§°">
                    </div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>ä»¿çœŸæ—¶é•¿ (å°æ—¶)</label>
                            <input type="number" id="sim-duration" value="24" min="1" max="168">
                        </div>
                        <div class="input-group">
                            <label>å¤©æ°”å› å­ (0-1.5)</label>
                            <input type="number" id="sim-weather" value="1.0" min="0" max="1.5" step="0.1">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>é£é€Ÿ (m/s)</label>
                            <input type="number" id="sim-wind" value="8" min="0" max="25">
                        </div>
                        <div class="input-group">
                            <label>åŸºç¡€è´Ÿè· (kW)</label>
                            <input type="number" id="sim-load" value="80" min="0">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="runSimulation()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 3l14 9-14 9V3z"/></svg>
                        å¼€å§‹ä»¿çœŸ
                    </button>
                </div>

                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-title">ğŸ“‹ ä»¿çœŸå†å²</div>
                    <div id="simulation-list" style="max-height: 280px; overflow-y: auto;">
                        <div class="data-row">
                            <span class="data-label">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="card-title">ğŸ“ˆ ä»¿çœŸç»“æœæ›²çº¿</div>
                <div class="chart-container" style="height: 380px;">
                    <canvas id="simulation-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- é¢„æµ‹åˆ†æ -->
        <div id="prediction-tab" class="tab-content" style="display: none;">
            <div class="grid-3">
                <div class="card fade-in">
                    <div class="card-title">ğŸ­ è´Ÿè·é¢„æµ‹</div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                        åŸºäºå†å²æ•°æ®å’Œå¤©æ°”å› ç´ é¢„æµ‹æœªæ¥è´Ÿè·å˜åŒ–è¶‹åŠ¿
                    </p>
                    <div class="input-group">
                        <label>é¢„æµ‹æ—¶é•¿ (å°æ—¶)</label>
                        <input type="number" id="pred-hours" value="24" min="1" max="168">
                    </div>
                    <button class="btn btn-primary" onclick="predictLoad()">å¼€å§‹é¢„æµ‹</button>
                </div>
                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-title">â˜€ï¸ å…‰ä¼é¢„æµ‹</div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                        æ ¹æ®å¤©æ°”é¢„æŠ¥å’Œè¾ç…§åº¦é¢„æµ‹å…‰ä¼å‘ç”µåŠŸç‡
                    </p>
                    <button class="btn btn-primary" onclick="predictSolar()" style="margin-top: 50px;">å¼€å§‹é¢„æµ‹</button>
                </div>
                <div class="card fade-in" style="animation-delay: 0.2s;">
                    <div class="card-title">ğŸ’¨ é£ç”µé¢„æµ‹</div>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                        åŸºäºé£é€Ÿé¢„æŠ¥é¢„æµ‹é£åŠ›å‘ç”µåŠŸç‡æ›²çº¿
                    </p>
                    <button class="btn btn-primary" onclick="predictWind()" style="margin-top: 50px;">å¼€å§‹é¢„æµ‹</button>
                </div>
            </div>
            <div class="card fade-in" style="animation-delay: 0.3s;">
                <div class="card-title">ğŸ“ˆ é¢„æµ‹ç»“æœæ›²çº¿</div>
                <div class="chart-container" style="height: 380px;">
                    <canvas id="prediction-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- è°ƒåº¦ä¼˜åŒ– -->
        <div id="optimization-tab" class="tab-content" style="display: none;">
            <div class="grid-2">
                <div class="card fade-in">
                    <div class="card-title">âš™ï¸ ä¼˜åŒ–å‚æ•°è®¾ç½®</div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>æŸ´æ²¹æˆæœ¬ (å…ƒ/kWh)</label>
                            <input type="number" id="opt-diesel-cost" value="1.2" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>è´­ç”µä»·æ ¼ (å…ƒ/kWh)</label>
                            <input type="number" id="opt-buy-price" value="0.8" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>å”®ç”µä»·æ ¼ (å…ƒ/kWh)</label>
                            <input type="number" id="opt-sell-price" value="0.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>ç”µæ± å¾ªç¯æˆæœ¬ (å…ƒ/kWh)</label>
                            <input type="number" id="opt-battery-cost" value="0.1" step="0.01">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="runOptimization()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        è¿è¡Œä¼˜åŒ–
                    </button>
                </div>
                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-title">ğŸ“Š ä¼˜åŒ–ç»“æœ</div>
                    <div class="data-panel" id="optimization-result">
                        <div class="data-row">
                            <span class="data-label">ç‚¹å‡»"è¿è¡Œä¼˜åŒ–"å¼€å§‹ç»æµè°ƒåº¦ä¼˜åŒ–</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="card-title">ğŸ“ˆ è°ƒåº¦è®¡åˆ’</div>
                <div class="chart-container" style="height: 380px;">
                    <canvas id="optimization-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹æ ‡å®š -->
        <div id="calibration-tab" class="tab-content" style="display: none;">
            <div class="grid-2">
                <div class="card fade-in">
                    <div class="card-title">ğŸ“¤ ä¸Šä¼ æ ‡å®šæ•°æ®</div>
                    <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 14px;">
                        è¯·è¾“å…¥å®é™…è¿è¡Œæ•°æ®ï¼ˆ24å°æ—¶ï¼Œæ¯å°æ—¶ä¸€ä¸ªå€¼ï¼Œç”¨é€—å·åˆ†éš”ï¼‰
                    </p>
                    <div class="input-group">
                        <label>â˜€ï¸ å…‰ä¼åŠŸç‡æ•°æ® (kW)</label>
                        <textarea id="cal-solar" rows="2" style="font-family: monospace; font-size: 13px;">0,0,0,0,0,0,5,20,45,65,80,90,95,90,80,65,45,20,5,0,0,0,0,0</textarea>
                    </div>
                    <div class="input-group">
                        <label>ğŸ’¨ é£ç”µåŠŸç‡æ•°æ® (kW)</label>
                        <textarea id="cal-wind" rows="2" style="font-family: monospace; font-size: 13px;">25,28,30,32,35,30,25,20,18,15,12,10,12,15,18,22,25,28,32,35,38,35,30,28</textarea>
                    </div>
                    <div class="input-group">
                        <label>ğŸ­ è´Ÿè·åŠŸç‡æ•°æ® (kW)</label>
                        <textarea id="cal-load" rows="2" style="font-family: monospace; font-size: 13px;">40,35,32,30,32,40,55,70,85,90,95,100,95,90,85,80,85,95,100,95,85,70,55,45</textarea>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="uploadCalibrationData()">ä¸Šä¼ æ•°æ®</button>
                        <button class="btn btn-secondary" onclick="runCalibration()">æ‰§è¡Œæ ‡å®š</button>
                    </div>
                </div>
                <div class="card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-title">ğŸ¯ æ ‡å®šç»“æœ</div>
                    <div class="data-panel" id="calibration-result">
                        <div class="data-row">
                            <span class="data-label">è¯·å…ˆä¸Šä¼ æ•°æ®å¹¶æ‰§è¡Œæ ‡å®š</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }

        let simChart, predChart, optChart;

        function initCharts() {
            const baseOpts = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        labels: { 
                            color: '#666666', 
                            font: { size: 12, family: 'Noto Sans SC' },
                            usePointStyle: true,
                            padding: 16
                        } 
                    } 
                },
                scales: {
                    x: { 
                        ticks: { color: '#999999', font: { size: 11 } }, 
                        grid: { color: 'rgba(0,0,0,0.05)' } 
                    },
                    y: { 
                        ticks: { color: '#999999', font: { size: 11 } }, 
                        grid: { color: 'rgba(0,0,0,0.05)' } 
                    }
                }
            };

            simChart = new Chart(document.getElementById('simulation-chart').getContext('2d'), {
                type: 'line', data: { labels: [], datasets: [] }, options: baseOpts
            });
            predChart = new Chart(document.getElementById('prediction-chart').getContext('2d'), {
                type: 'line', data: { labels: [], datasets: [] }, options: baseOpts
            });
            optChart = new Chart(document.getElementById('optimization-chart').getContext('2d'), {
                type: 'bar', data: { labels: [], datasets: [] }, options: baseOpts
            });
        }

        async function runSimulation() {
            const params = {
                name: document.getElementById('sim-name').value,
                duration_hours: parseInt(document.getElementById('sim-duration').value),
                weather_factor: parseFloat(document.getElementById('sim-weather').value),
                wind_speed: parseFloat(document.getElementById('sim-wind').value),
                base_load: parseFloat(document.getElementById('sim-load').value)
            };
            const response = await fetch('/api/simulation/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
            const result = await response.json();

            const labels = result.data.map((d, i) => `${i}h`);
            simChart.data = {
                labels: labels,
                datasets: [
                    { label: 'å…‰ä¼', data: result.data.map(d => d.solar_power), borderColor: '#ff9500', backgroundColor: 'rgba(255,149,0,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'é£ç”µ', data: result.data.map(d => d.wind_power), borderColor: '#00b578', backgroundColor: 'rgba(0,181,120,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'è´Ÿè·', data: result.data.map(d => d.load_power), borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'ç”µæ± ', data: result.data.map(d => d.battery_power), borderColor: '#1890ff', backgroundColor: 'rgba(24,144,255,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'ç”µç½‘', data: result.data.map(d => d.grid_power), borderColor: '#722ed1', backgroundColor: 'rgba(114,46,209,0.1)', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 }
                ]
            };
            simChart.update();
            loadSimulationList();
            alert('ä»¿çœŸå®Œæˆï¼');
        }

        async function loadSimulationList() {
            const response = await fetch('/api/simulation/list');
            const simulations = await response.json();
            const list = document.getElementById('simulation-list');
            if (simulations.length === 0) {
                list.innerHTML = '<div class="data-row"><span class="data-label">æš‚æ— ä»¿çœŸè®°å½•</span></div>';
                return;
            }
            list.innerHTML = simulations.map(sim => `
                <div class="data-row" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='var(--bg-gray)'" onmouseout="this.style.background=''" onclick="loadSimulationData(${sim.id})">
                    <span class="data-label">${sim.name}</span>
                    <span class="badge ${sim.status === 'completed' ? 'badge-success' : 'badge-info'}">${sim.status === 'completed' ? 'å·²å®Œæˆ' : 'è¿è¡Œä¸­'}</span>
                </div>
            `).join('');
        }

        async function loadSimulationData(simId) {
            const response = await fetch(`/api/simulation/${simId}/data`);
            const data = await response.json();
            const labels = data.map((d, i) => `${i}h`);
            simChart.data = {
                labels: labels,
                datasets: [
                    { label: 'å…‰ä¼', data: data.map(d => d.solar_power), borderColor: '#ff9500', fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'é£ç”µ', data: data.map(d => d.wind_power), borderColor: '#00b578', fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'è´Ÿè·', data: data.map(d => d.load_power), borderColor: '#ff6b6b', fill: false, tension: 0.4, pointRadius: 0, borderWidth: 2 }
                ]
            };
            simChart.update();
        }

        async function predictLoad() {
            const hours = document.getElementById('pred-hours').value;
            const response = await fetch(`/api/prediction/load?hours=${hours}`);
            const result = await response.json();
            updatePredictionChart(result.predictions, 'è´Ÿè·', '#ff6b6b');
        }

        async function predictSolar() {
            const response = await fetch('/api/prediction/solar?hours=24');
            const result = await response.json();
            updatePredictionChart(result.predictions, 'å…‰ä¼', '#ff9500');
        }

        async function predictWind() {
            const response = await fetch('/api/prediction/wind?hours=24');
            const result = await response.json();
            updatePredictionChart(result.predictions, 'é£ç”µ', '#00b578');
        }

        function updatePredictionChart(predictions, label, color) {
            predChart.data = {
                labels: predictions.map(p => `${p.hour}h`),
                datasets: [
                    { label: `${label}é¢„æµ‹`, data: predictions.map(p => p.predicted_value), borderColor: color, backgroundColor: color + '20', fill: true, tension: 0.4, pointRadius: 0, borderWidth: 2 },
                    { label: 'ç½®ä¿¡ä¸Šç•Œ', data: predictions.map(p => p.confidence_upper), borderColor: color + '60', borderDash: [5,5], fill: false, pointRadius: 0, borderWidth: 1 },
                    { label: 'ç½®ä¿¡ä¸‹ç•Œ', data: predictions.map(p => p.confidence_lower), borderColor: color + '60', borderDash: [5,5], fill: false, pointRadius: 0, borderWidth: 1 }
                ]
            };
            predChart.update();
        }

        async function runOptimization() {
            const response = await fetch('/api/optimization/dispatch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();

            document.getElementById('optimization-result').innerHTML = `
                <div class="data-row" style="border-color: var(--green);">
                    <span class="data-label">ä¼˜åŒ–çŠ¶æ€</span>
                    <span class="badge ${result.success ? 'badge-success' : 'badge-danger'}">${result.success ? 'âœ“ ä¼˜åŒ–æˆåŠŸ' : 'âœ— ä¼˜åŒ–å¤±è´¥'}</span>
                </div>
                <div class="data-row" style="border-color: var(--primary);">
                    <span class="data-label">æ€»è¿è¥æˆæœ¬</span>
                    <span class="data-value" style="color: var(--primary); font-size: 20px;">${result.total_cost} <span style="font-size: 14px;">å…ƒ</span></span>
                </div>
                <div class="data-row">
                    <span class="data-label">ä¼˜åŒ–ç®—æ³•</span>
                    <span class="data-value">ç»æµè°ƒåº¦ä¼˜åŒ–</span>
                </div>
            `;

            optChart.data = {
                labels: result.dispatch_plan.map(d => `${d.hour}h`),
                datasets: [
                    { label: 'å…‰ä¼è°ƒåº¦', data: result.dispatch_plan.map(d => d.solar_dispatch), backgroundColor: '#ff9500' },
                    { label: 'é£ç”µè°ƒåº¦', data: result.dispatch_plan.map(d => d.wind_dispatch), backgroundColor: '#00b578' },
                    { label: 'æŸ´æ²¹æœº', data: result.dispatch_plan.map(d => d.diesel_dispatch), backgroundColor: '#ff6b6b' },
                    { label: 'ç”µç½‘è´­ç”µ', data: result.dispatch_plan.map(d => d.grid_purchase), backgroundColor: '#722ed1' }
                ]
            };
            optChart.options.scales.x.stacked = true;
            optChart.options.scales.y.stacked = true;
            optChart.update();
        }

        async function uploadCalibrationData() {
            const solarData = document.getElementById('cal-solar').value.split(',').map(Number);
            const windData = document.getElementById('cal-wind').value.split(',').map(Number);
            const loadData = document.getElementById('cal-load').value.split(',').map(Number);

            const response = await fetch('/api/calibration/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ solar_power: solarData, wind_power: windData, load_power: loadData })
            });
            const result = await response.json();
            alert(result.message);
        }

        async function runCalibration() {
            const response = await fetch('/api/calibration/run', { method: 'POST' });
            const result = await response.json();

            if (result.status === 'success') {
                const params = result.calibrated_params;
                document.getElementById('calibration-result').innerHTML = `
                    <div class="data-row" style="border-color: var(--solar);"><span class="data-label">â˜€ï¸ æ ‡å®šå…‰ä¼å®¹é‡</span><span class="data-value" style="color: var(--solar);">${params.solar_capacity.toFixed(1)} kW</span></div>
                    <div class="data-row" style="border-color: var(--wind);"><span class="data-label">ğŸ’¨ æ ‡å®šé£ç”µå®¹é‡</span><span class="data-value" style="color: var(--wind);">${params.wind_capacity.toFixed(1)} kW</span></div>
                    <div class="data-row" style="border-color: var(--load);"><span class="data-label">ğŸ­ æ ‡å®šåŸºç¡€è´Ÿè·</span><span class="data-value" style="color: var(--load);">${params.base_load.toFixed(1)} kW</span></div>
                    <div class="data-row" style="border-color: var(--green);"><span class="data-label">çŠ¶æ€</span><span class="badge badge-success">âœ“ æ ‡å®šå®Œæˆ</span></div>
                `;
            } else {
                alert(result.message);
            }
        }

        initCharts();
        loadSimulationList();
    </script>
</body>
</html>
